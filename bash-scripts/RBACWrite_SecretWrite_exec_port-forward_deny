#!/bin/bash
# Step 0: namespace + SA
kubectl create ns audit-sim || true
kubectl -n audit-sim create sa intruder || true

# Step 1: RBAC create/patch/delete
kubectl -n audit-sim create role sim-role --verb=get --resource=pods || true
kubectl -n audit-sim create rolebinding sim-rb --role=sim-role --serviceaccount=audit-sim:intruder || true
kubectl -n audit-sim patch role sim-role --type='json' -p='[{"op":"add","path":"/rules/0/verbs/-","value":"list"}]'
kubectl -n audit-sim delete rolebinding sim-rb
kubectl -n audit-sim delete role sim-role

# Step 2: Secret create/patch/delete
kubectl -n audit-sim create secret generic demo-secret --from-literal=token=hello || true
kubectl -n audit-sim patch secret demo-secret -p '{"stringData":{"token":"rotated"}}'
kubectl -n audit-sim delete secret demo-secret

# Step 3: Exec
kubectl -n audit-sim run audit-debug --image=busybox:1.36 --restart=Never --command -- sh -c 'sleep 120'
kubectl -n audit-sim wait --for=condition=Ready pod/audit-debug --timeout=60s
kubectl -n audit-sim exec -it audit-debug -- sh -lc 'id; date'
kubectl -n audit-sim delete pod audit-debug

# Step 4: Port-forward (clean)
kubectl -n audit-sim run web --image=nginx --restart=Never
kubectl -n audit-sim expose pod web --port=80
kubectl -n audit-sim wait --for=condition=Ready pod/web --timeout=60s
kubectl -n audit-sim port-forward svc/web 8080:80 &
PF_PID=$!
sleep 8
kill $PF_PID
kubectl -n audit-sim delete svc web
kubectl -n audit-sim delete pod web

# Step 5: 403 Forbidden (intruder tries kube-system secrets)
kubectl -n audit-sim run intruder-curl --rm -i --restart=Never \
  --image=curlimages/curl \
  --overrides='{ "spec": { "serviceAccountName": "intruder" } }' -- sh -lc '
TOKEN=$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)
curl -sk -H "Authorization: Bearer $TOKEN" \
  https://kubernetes.default.svc/api/v1/namespaces/kube-system/secrets | head
'

